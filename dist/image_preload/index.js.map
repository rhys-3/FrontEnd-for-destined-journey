{"version":3,"file":"index.js","mappings":"AAAA,MAAM,EAA+BA,ECA/BC,EAAW,EAAAD,EAAEE,OAAO,CACtB,KAAM,EAAAF,EAAEG,SAASC,QAAQ,MAEvBC,EAAkB,CAAEC,KAAM,SAAUC,UAAWC,eAoBrD,MAUMC,EAAqBC,MAAOC,EAAOC,EAAaC,EAAsB,KACxE,MAAMC,EAAU,GAChB,IAAIC,EAAQ,EACZ,MAcMC,EAAUC,MAAMC,KAAKC,IAAIP,EAAaD,EAAMS,SAC7CC,KAAK,MACLC,IAAIZ,MAAOa,EAAGC,KAEXX,EAAsB,GAAKW,EAAc,SACnC,IAAIC,QAAQC,GAAWC,WAAWD,EAASb,EAAsBW,SAnB/Dd,WACZ,KAAOK,EAAQJ,EAAMS,QAAQ,CACzB,MAAMQ,EAAeb,IACfc,EAAOlB,EAAMiB,GACnB,IACI,MAAME,QAAcD,IACpBf,EAAQc,GAAgB,CAAEG,OAAQ,YAAaD,QACnD,CACA,MAAOE,GACHlB,EAAQc,GAAgB,CAAEG,OAAQ,WAAYC,SAClD,CACJ,GAUMC,KAGV,aADMR,QAAQS,IAAIlB,GACXF,GA+BLqB,EAAuBzB,MAAO0B,SAZf,CAACA,GACX,IAAIX,QAAQC,IACf,MAAMW,EAAM,IAAIC,MAChBD,EAAIE,YAAc,YAClBF,EAAIG,OAAS,IAAMd,IACnBW,EAAII,QAAU,IAAMf,IACpBW,EAAIK,IAAMN,IAORO,CAAaP,QA9BJ1B,OAAO0B,IACtB,GAAM,WAAYQ,OAElB,IACI,MAAMC,QAAcC,OAAOC,KA3ChB,6BA6CX,SADqBF,EAAMG,MAAMZ,GAE7B,OACJ,MAAMa,QAAiBC,MAAMd,EAAO,CAAEe,KAAM,SACxCF,EAASG,UACHP,EAAMQ,IAAIjB,EAAOa,EAASK,QAExC,CACA,MAAOC,GACHC,QAAQC,KAAK,yBAA0BrB,EAAOmB,EAClD,GAgBMG,CAAWtB,IAErBuB,EAAE,KAEE,MAAMC,EAAYrC,EAAEsC,KA7FxB,WACI,MAAMC,EAAW7D,EAAS8D,MAAMC,aAAa3D,IAE7C,OADA4D,gBAAgBH,EAAUzD,GACnBkB,EAAE2C,oBACJC,OAAOC,GAASA,EAAMC,SAAWD,EAAME,YAAYC,SAAS,QAC5DjD,IAAI8C,IAAS,CACdI,MAAOJ,EAAME,YAAYG,QAAQ,MAAO,IAAIC,WAAW,UAAW,IAClEC,QAASP,EAAMQ,kBAEdC,OAAO,CAAC,CAAEL,MAAO,OAAQG,QAASb,EAAS,QAC3CxC,IAAI,EAAGkD,QAAOG,cAAc,CAC7BH,QACAM,OAAQH,EACHI,MAAM,MACNzD,IAAIc,GAASA,EAAM4C,QACnBb,OAAO/B,KAAWA,MAEtBN,OACT,CA2E6BmD,GAAiBC,QAAQC,GAAYA,EAASL,SAEjEnE,EAAQiD,EAAUtC,IAAIc,GAAS,IAAMD,EAAqBC,IAEhE3B,EAAmBE,EA5EG,EACN,KA2E0CyE,KAAKtE,IAC3D,MAAMuE,EAAYvE,EAAQqD,OAAOmB,GAAkB,cAAbA,EAAEvD,QAAwBX,OAC1DmE,EAASzE,EAAQqD,OAAOmB,GAAkB,aAAbA,EAAEvD,QAAuBX,OACxDwC,EAAUxC,OAAS,GACnBoC,QAAQgC,IAAI,yBAAyBH,SAAiBE,WAAgB3B,EAAUxC","sources":["src://tavern_helper_template/external var \"z\"","src://tavern_helper_template/src/image_preload/index.ts"],"sourcesContent":["const __WEBPACK_NAMESPACE_OBJECT__ = z;","const Settings = z.object({\n    资源预载: z.string().default(''),\n});\nconst variable_option = { type: 'script', script_id: getScriptId() };\nfunction get_prefetches() {\n    const settings = Settings.parse(getVariables(variable_option));\n    insertVariables(settings, variable_option);\n    return _(getTavernRegexes())\n        .filter(regex => regex.enabled && regex.script_name.includes('预载-'))\n        .map(regex => ({\n        title: regex.script_name.replace('预载-', '').replaceAll(/【.+?】/gs, ''),\n        content: regex.replace_string,\n    }))\n        .concat([{ title: '脚本变量', content: settings.资源预载 }])\n        .map(({ title, content }) => ({\n        title,\n        assets: content\n            .split('\\n')\n            .map(asset => asset.trim())\n            .filter(asset => !!asset),\n    }))\n        .value();\n}\nconst CACHE_NAME = 'destined-journey-cache-v1';\n// 并发控制配置\nconst CONCURRENCY_LIMIT = 4; // 同时进行的最大请求数\nconst BATCH_DELAY = 100; // 批次间隔（毫秒）\n/**\n * 批量执行任务，限制并发数量\n * @param tasks 任务函数数组\n * @param concurrency 最大并发数\n * @param delayBetweenBatches 批次间隔\n */\nconst runWithConcurrency = async (tasks, concurrency, delayBetweenBatches = 0) => {\n    const results = [];\n    let index = 0;\n    const runNext = async () => {\n        while (index < tasks.length) {\n            const currentIndex = index++;\n            const task = tasks[currentIndex];\n            try {\n                const value = await task();\n                results[currentIndex] = { status: 'fulfilled', value };\n            }\n            catch (reason) {\n                results[currentIndex] = { status: 'rejected', reason };\n            }\n        }\n    };\n    // 启动 concurrency 个并发 worker\n    const workers = Array(Math.min(concurrency, tasks.length))\n        .fill(null)\n        .map(async (_, workerIndex) => {\n        // 为每个 worker 添加初始延迟，避免同时启动\n        if (delayBetweenBatches > 0 && workerIndex > 0) {\n            await new Promise(resolve => setTimeout(resolve, delayBetweenBatches * workerIndex));\n        }\n        await runNext();\n    });\n    await Promise.all(workers);\n    return results;\n};\nconst cacheAsset = async (asset) => {\n    if (!('caches' in window))\n        return;\n    try {\n        const cache = await caches.open(CACHE_NAME);\n        const cached = await cache.match(asset);\n        if (cached)\n            return;\n        const response = await fetch(asset, { mode: 'cors' });\n        if (response.ok) {\n            await cache.put(asset, response.clone());\n        }\n    }\n    catch (error) {\n        console.warn('[ImagePreload] 缓存资源失败:', asset, error);\n    }\n};\nconst preloadImage = (asset) => {\n    return new Promise(resolve => {\n        const img = new Image();\n        img.crossOrigin = 'anonymous';\n        img.onload = () => resolve();\n        img.onerror = () => resolve();\n        img.src = asset;\n    });\n};\n/**\n * 预加载并缓存单个资源\n */\nconst preloadAndCacheAsset = async (asset) => {\n    await preloadImage(asset);\n    await cacheAsset(asset);\n};\n$(() => {\n    // 收集所有需要预加载的资源（去重）\n    const allAssets = _.uniq(get_prefetches().flatMap(prefetch => prefetch.assets));\n    // 转换为任务函数数组\n    const tasks = allAssets.map(asset => () => preloadAndCacheAsset(asset));\n    // 使用并发控制执行预加载\n    runWithConcurrency(tasks, CONCURRENCY_LIMIT, BATCH_DELAY).then(results => {\n        const succeeded = results.filter(r => r.status === 'fulfilled').length;\n        const failed = results.filter(r => r.status === 'rejected').length;\n        if (allAssets.length > 0) {\n            console.log(`[ImagePreload] 预加载完成: ${succeeded} 成功, ${failed} 失败, 共 ${allAssets.length} 个资源`);\n        }\n    });\n});\nexport {};\n"],"names":["z","Settings","object","string","default","variable_option","type","script_id","getScriptId","runWithConcurrency","async","tasks","concurrency","delayBetweenBatches","results","index","workers","Array","Math","min","length","fill","map","_","workerIndex","Promise","resolve","setTimeout","currentIndex","task","value","status","reason","runNext","all","preloadAndCacheAsset","asset","img","Image","crossOrigin","onload","onerror","src","preloadImage","window","cache","caches","open","match","response","fetch","mode","ok","put","clone","error","console","warn","cacheAsset","$","allAssets","uniq","settings","parse","getVariables","insertVariables","getTavernRegexes","filter","regex","enabled","script_name","includes","title","replace","replaceAll","content","replace_string","concat","assets","split","trim","get_prefetches","flatMap","prefetch","then","succeeded","r","failed","log"],"sourceRoot":""}